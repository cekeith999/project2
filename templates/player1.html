<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Player 1</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }
    .opt { padding: 8px 12px; margin: 6px 0; border: 1px solid #ccc; border-radius: 8px; display: inline-block; cursor: pointer; }
    .opt.sel { border-color: #222; background: #eee; }
    .row { margin-top: 8px; }
    button { padding: 8px 12px; }
    code { background: #f4f4f4; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h2>Player 1 — Choose your answer</h2>

  <div id="q">Loading question…</div>

  <div id="options" class="row"></div>

  <div class="row">
    <button id="lockBtn">Lock In</button>
    <span id="status" style="margin-left:10px;"></span>
  </div>

  <hr />
  <div>
    <small>Tip: You can click options, or use the Arduino joystick if connected.<br>
    Latest event: <code id="latest">—</code></small>
  </div>

<script>
  const $q = document.getElementById('q');
  const $opts = document.getElementById('options');
  const $status = document.getElementById('status');
  const $latest = document.getElementById('latest');
  const $lock = document.getElementById('lockBtn');

  let state = null;

  function render() {
    if (!state) return;
    $q.textContent = state.question;
    $opts.innerHTML = '';
    state.options.forEach((txt, i) => {
      const a = document.createElement('a');
      a.textContent = txt;
      a.className = 'opt' + (state.p1_selected === i ? ' sel' : '');
      a.onclick = () => select(i);
      $opts.appendChild(a);
      $opts.appendChild(document.createElement('br'));
    });
    $status.textContent = state.locked ? 'Locked ✅' : (state.p1_selected != null ? `Selected: ${state.options[state.p1_selected]}` : 'No selection');
    $lock.disabled = state.locked || state.p1_selected == null;
  }

  async function loadState() {
    const r = await fetch('/state');
    state = await r.json();
    render();
  }

  async function select(idx) {
    await fetch('/api/p1/select', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ idx }) });
  }

  async function lock() {
    await fetch('/api/p1/lock', { method:'POST' });
  }

  $lock.onclick = lock;

  // Event stream (SSE) to get live updates (from Arduino or other clients)
  const es = new EventSource('/events');
  es.onmessage = (ev) => {
    $latest.textContent = ev.data;
    try {
      const msg = JSON.parse(ev.data);
      if (msg.type === 'state') {
        state = msg.payload;
        render();
      }
    } catch (_) {}
  };

  // Initial state fetch
  loadState();
</script>
</body>
</html>
